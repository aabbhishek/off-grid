name: Deploy React App to GitHub Pages

on:
  push:
    branches:
      - main
  # Allow manual trigger from Actions tab
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for changelog generation

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build
        env:
          CI: false  # Prevents treating warnings as errors

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist

      # Auto Release Creation with Semantic Versioning
      - name: Get package version
        id: package_version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Get last release tag
        id: last_tag
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "tag=$LAST_TAG" >> $GITHUB_OUTPUT

      - name: Generate categorized changelog
        id: changelog
        run: |
          LAST_TAG="${{ steps.last_tag.outputs.tag }}"
          
          if [ -z "$LAST_TAG" ]; then
            RANGE="HEAD"
          else
            RANGE="${LAST_TAG}..HEAD"
          fi
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          
          # Features (feat:)
          FEATURES=$(git log $RANGE --pretty=format:"- %s (%h)" --grep="^feat" --extended-regexp 2>/dev/null || echo "")
          if [ -n "$FEATURES" ]; then
            echo "## âœ¨ New Features" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "$FEATURES" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
          fi
          
          # Bug Fixes (fix:)
          FIXES=$(git log $RANGE --pretty=format:"- %s (%h)" --grep="^fix" --extended-regexp 2>/dev/null || echo "")
          if [ -n "$FIXES" ]; then
            echo "## ðŸ› Bug Fixes" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "$FIXES" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
          fi
          
          # Performance (perf:)
          PERF=$(git log $RANGE --pretty=format:"- %s (%h)" --grep="^perf" --extended-regexp 2>/dev/null || echo "")
          if [ -n "$PERF" ]; then
            echo "## âš¡ Performance Improvements" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "$PERF" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
          fi
          
          # Documentation (docs:)
          DOCS=$(git log $RANGE --pretty=format:"- %s (%h)" --grep="^docs" --extended-regexp 2>/dev/null || echo "")
          if [ -n "$DOCS" ]; then
            echo "## ðŸ“š Documentation" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "$DOCS" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
          fi
          
          # Refactoring (refactor:)
          REFACTOR=$(git log $RANGE --pretty=format:"- %s (%h)" --grep="^refactor" --extended-regexp 2>/dev/null || echo "")
          if [ -n "$REFACTOR" ]; then
            echo "## â™»ï¸ Code Refactoring" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "$REFACTOR" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
          fi
          
          # Styling (style:)
          STYLE=$(git log $RANGE --pretty=format:"- %s (%h)" --grep="^style" --extended-regexp 2>/dev/null || echo "")
          if [ -n "$STYLE" ]; then
            echo "## ðŸ’„ Styling" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "$STYLE" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
          fi
          
          # Chores (chore:)
          CHORE=$(git log $RANGE --pretty=format:"- %s (%h)" --grep="^chore" --extended-regexp 2>/dev/null || echo "")
          if [ -n "$CHORE" ]; then
            echo "## ðŸ”§ Maintenance" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "$CHORE" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
          fi
          
          # Tests (test:)
          TESTS=$(git log $RANGE --pretty=format:"- %s (%h)" --grep="^test" --extended-regexp 2>/dev/null || echo "")
          if [ -n "$TESTS" ]; then
            echo "## âœ… Tests" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "$TESTS" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
          fi
          
          # Build (build:)
          BUILD=$(git log $RANGE --pretty=format:"- %s (%h)" --grep="^build" --extended-regexp 2>/dev/null || echo "")
          if [ -n "$BUILD" ]; then
            echo "## ðŸ—ï¸ Build System" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "$BUILD" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
          fi
          
          # CI (ci:)
          CI_CHANGES=$(git log $RANGE --pretty=format:"- %s (%h)" --grep="^ci" --extended-regexp 2>/dev/null || echo "")
          if [ -n "$CI_CHANGES" ]; then
            echo "## ðŸ‘· CI/CD" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "$CI_CHANGES" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
          fi
          
          # Other commits (not matching conventional pattern)
          OTHER=$(git log $RANGE --pretty=format:"- %s (%h)" --invert-grep --grep="^feat\|^fix\|^perf\|^docs\|^refactor\|^style\|^chore\|^test\|^build\|^ci" --extended-regexp 2>/dev/null | head -20 || echo "")
          if [ -n "$OTHER" ]; then
            echo "## ðŸ“ Other Changes" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "$OTHER" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
          fi
          
          echo "---" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "## ðŸš€ Deployment Info" >> $GITHUB_OUTPUT
          echo "- **Live URL:** https://off-grid.darkpkt.cloud" >> $GITHUB_OUTPUT
          echo "- **Build Date:** ${{ steps.date.outputs.date }}" >> $GITHUB_OUTPUT
          echo "- **Node Version:** 20" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "## ðŸ› ï¸ Available Tools" >> $GITHUB_OUTPUT
          echo "| Tool | Shortcut | Description |" >> $GITHUB_OUTPUT
          echo "|------|----------|-------------|" >> $GITHUB_OUTPUT
          echo "| JWT Toolkit | \`1\` | Decode, validate, and build JSON Web Tokens |" >> $GITHUB_OUTPUT
          echo "| JSON Toolkit | \`2\` | Format, validate, visualize, and compare JSON |" >> $GITHUB_OUTPUT
          echo "| Encode/Decode | \`3\` | Base64, URL, HTML entities, and more |" >> $GITHUB_OUTPUT
          echo "| Hash Generator | \`4\` | MD5, SHA-1, SHA-256, SHA-384, SHA-512 |" >> $GITHUB_OUTPUT
          echo "| UUID Generator | \`5\` | Generate UUIDs v1, v4, and v7 |" >> $GITHUB_OUTPUT
          echo "| SSL/TLS Toolkit | \`6\` | Parse certificates, generate CSR, convert formats |" >> $GITHUB_OUTPUT
          echo "| Log Analyzer | \`7\` | Parse, search, and visualize logs |" >> $GITHUB_OUTPUT
          echo "| Local Vault | \`8\` | Encrypted credential storage |" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "## ðŸ”’ Privacy" >> $GITHUB_OUTPUT
          echo "All processing happens locally in your browser. No data is ever transmitted to any server." >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Calculate semantic version
        id: semver
        run: |
          LAST_TAG="${{ steps.last_tag.outputs.tag }}"
          
          # Extract version numbers from last tag (format: v1.2.3 or 1.2.3)
          if [ -z "$LAST_TAG" ]; then
            MAJOR=1
            MINOR=0
            PATCH=0
          else
            # Remove 'v' prefix if present and any build suffix
            VERSION=$(echo "$LAST_TAG" | sed 's/^v//' | cut -d'-' -f1)
            MAJOR=$(echo "$VERSION" | cut -d'.' -f1)
            MINOR=$(echo "$VERSION" | cut -d'.' -f2)
            PATCH=$(echo "$VERSION" | cut -d'.' -f3)
            
            # Default to 0 if not set
            MAJOR=${MAJOR:-1}
            MINOR=${MINOR:-0}
            PATCH=${PATCH:-0}
          fi
          
          if [ -z "$LAST_TAG" ]; then
            RANGE="HEAD"
          else
            RANGE="${LAST_TAG}..HEAD"
          fi
          
          # Count commits by type
          BREAKING=$(git log $RANGE --grep="BREAKING CHANGE\|^.*!:" --extended-regexp 2>/dev/null | wc -l)
          FEATURES=$(git log $RANGE --grep="^feat" --extended-regexp 2>/dev/null | wc -l)
          FIXES=$(git log $RANGE --grep="^fix" --extended-regexp 2>/dev/null | wc -l)
          
          # Determine version bump based on semantic versioning
          # Major.Minor.Patch where Minor = features, Patch = fixes
          if [ "$BREAKING" -gt 0 ]; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            LABEL="ðŸš¨ Breaking Changes"
          elif [ "$FEATURES" -gt 0 ]; then
            MINOR=$((MINOR + FEATURES))
            LABEL="âœ¨ New Features"
          elif [ "$FIXES" -gt 0 ]; then
            PATCH=$((PATCH + FIXES))
            LABEL="ðŸ› Bug Fixes"
          else
            # Default: increment patch for other changes
            PATCH=$((PATCH + 1))
            LABEL="ðŸ“¦ Update"
          fi
          
          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "major=$MAJOR" >> $GITHUB_OUTPUT
          echo "minor=$MINOR" >> $GITHUB_OUTPUT
          echo "patch=$PATCH" >> $GITHUB_OUTPUT
          echo "label=$LABEL" >> $GITHUB_OUTPUT
          echo "Calculated version: $NEW_VERSION"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.semver.outputs.version }}
          name: "${{ steps.semver.outputs.version }}"
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create ZIP artifact
        run: |
          cd dist
          zip -r ../offgrid-${{ steps.semver.outputs.version }}.zip .
          cd ..

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.semver.outputs.version }}
          files: offgrid-${{ steps.semver.outputs.version }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
